---
import NavbarItem from './NavbarItem.astro';
import Logo from './Logo.astro';
import { X } from '@lucide/astro';
import { Menu } from '@lucide/astro';
---

<header class="border-b border-primary-500 w-full fixed top-0 bg-white z-10">
  <p class="w-full bg-amber-50 text-center p-1">
    üöß Str√°nka je st√°le ve v√Ωvoji. Omluvte pros√≠m jej√≠ nedostatky. üöß
  </p>
  <nav
    class="mx-4 md:mx-12 border-x border-primary-500 px-4 py-1 h-12 flex items-center justify-between"
  >
    <a class="h-full" href="/">
      <Logo />
    </a>

    <button
      id="menu-toggle"
      class="md:hidden z-50 w-8 h-8 flex flex-col justify-center items-center gap-1.5 focus:outline-none"
      aria-label="Toggle menu"
      aria-expanded="false"
    >
      <Menu />
      <X class="hidden" />
    </button>

    <!-- Navigation Menu -->
    <nav
      id="menu"
      class="fixed top-0 right-0 bottom-0 left-0 bg-white flex flex-col justify-center items-center gap-8 md:gap-6 translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out md:static md:flex-row md:bg-transparent z-40"
    >
      <NavbarItem name="dom≈Ø" href="/" class="md:hidden" />
      <NavbarItem name="projekty" href="/projects" />
      <NavbarItem name="o Integeru" href="/about" />
      <NavbarItem name="kontakt" href="/contact" highlight="true" />
    </nav>
  </nav>
</header>

<style>
  #menu-toggle.menu-open svg:nth-child(1) {
    display: none;
  }

  #menu-toggle.menu-open svg:nth-child(2) {
    display: block;
  }

  /* Disable transition during swipe for smooth following */
  #menu.swiping {
    transition: none;
  }
</style>

<script>
  const menuToggle = document.getElementById('menu-toggle');
  const menu = document.getElementById('menu');

  if (menuToggle && menu) {
    // Toggle menu function
    const toggleMenu = (open: boolean) => {
      if (open) {
        menuToggle.classList.add('menu-open');
        menuToggle.setAttribute('aria-expanded', 'true');
        menu.classList.remove('translate-x-full');
        document.body.style.overflow = 'hidden';
      } else {
        menuToggle.classList.remove('menu-open');
        menuToggle.setAttribute('aria-expanded', 'false');
        menu.classList.add('translate-x-full');
        document.body.style.overflow = '';
      }
    };

    // Click toggle
    menuToggle.addEventListener('click', () => {
      const isOpen = menuToggle.classList.contains('menu-open');
      toggleMenu(!isOpen);
    });

    // Touch swipe handling
    let touchStartX = 0;
    let touchStartY = 0;
    let touchCurrentX = 0;
    let isSwiping = false;

    menu.addEventListener('touchstart', (e) => {
      if (window.innerWidth >= 768) return; // Only on mobile
      if (!menuToggle.classList.contains('menu-open')) return;

      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isSwiping = false;
    });

    menu.addEventListener('touchmove', (e) => {
      if (window.innerWidth >= 768) return;
      if (!menuToggle.classList.contains('menu-open')) return;

      touchCurrentX = e.touches[0].clientX;
      const touchCurrentY = e.touches[0].clientY;
      const diffX = touchCurrentX - touchStartX;
      const diffY = touchCurrentY - touchStartY;

      // Determine if this is a horizontal swipe
      if (!isSwiping && Math.abs(diffX) > 10) {
        if (Math.abs(diffX) > Math.abs(diffY)) {
          isSwiping = true;
          menu.classList.add('swiping');
        }
      }

      // Follow the finger during swipe (only if swiping right)
      if (isSwiping && diffX > 0) {
        e.preventDefault();
        menu.style.transform = `translateX(${diffX}px)`;
      }
    });

    menu.addEventListener('touchend', (e) => {
      if (window.innerWidth >= 768) return;
      if (!menuToggle.classList.contains('menu-open')) return;

      menu.classList.remove('swiping');
      menu.style.transform = '';

      const diffX = touchCurrentX - touchStartX;
      const swipeThreshold = 100; // Minimum distance to trigger close

      // If swiped right beyond threshold, close the menu
      if (isSwiping && diffX > swipeThreshold) {
        toggleMenu(false);
      }

      isSwiping = false;
      touchStartX = 0;
      touchCurrentX = 0;
    });

    // Close menu when clicking on a menu item
    const menuItems = menu.querySelectorAll('a');
    menuItems.forEach((item) => {
      item.addEventListener('click', () => {
        if (window.innerWidth < 768) {
          toggleMenu(false);
        }
      });
    });

    // Handle window resize
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768) {
        toggleMenu(false);
      }
    });
  }
</script>
